<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign2025</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Rashi+Hebrew&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Heebo&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Heebo', sans-serif;
      background: url('/mnt/data/Untitled-1 (1).jpg') no-repeat center center fixed;
      background-color: #000000;
      background-size: cover;
      color: white;
      direction: rtl;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    /* מצב אתחולי – רק הכפתור מופיע במרכז העמוד */
    #initial-state {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #start-button {
      background: none;
      border: none;
      cursor: pointer;
    }
    #start-button svg {
      fill: white;
      width: 60px;
      height: 60px;
    }
    #start-button:hover svg {
      fill: grey;
    }
    /* הודעת טעינה – מוסתרת בהתחלה */
    #loading {
      font-size: 20px;
      color: black;
      display: none;
    }
    /* תוכן ראשי – מוסתר בהתחלה */
    #content-wrapper {
      display: none;
      padding: 20px;
      position: relative;
      z-index: 1;
    }
    /* Header עם הלוגו, כותרת ו—buton רענון */
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    #logo-container {
      position: relative;
    }
    #logo {
      height: 50px;
    }
    .header-text {
      font-size: 30px;
      color: white;
    }
    /* כפתור רענון בתוך ה-header */
    #fetch-button {
      background: none;
      border: none;
      cursor: pointer;
    }
    #fetch-button svg {
      fill: white;
      width: 30px;
      height: 30px;
    }
    #fetch-button:hover svg {
      fill: grey;
    }
    .global-progress-bar {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 5px;
      height: 30px;
      margin-top: 20px;
    }
    .global-progress {
      height: 100%;
      background-color: green;
      border-radius: 5px;
    }
    .global-progress-text {
      font-size: 10px;
      color: black;
      text-align: center;
      line-height: 30px;
    }
    #people-container {
      display: none;
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .people-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 32%;
    }
    .people-column h3 {
      color: white;
      font-size: 24px;
      margin-bottom: 10px;
    }
    .person {
      background-color: #4a6a93;
      padding: 15px;
      margin: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 100%;
      text-align: center;
      color: white;
    }
    .person-name {
      font-size: 20px;
      color: black;
      margin-bottom: 5px;
    }
    .person-info {
      font-size: 18px;
      color: black;
    }
    .person-info .amount,
    .person-info .target {
      display: inline-block;
      width: 45%;
    }
    .progress-bar {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 5px;
      height: 20px;
      margin-top: 10px;
    }
    .progress {
      height: 100%;
      background-color: green;
      border-radius: 5px;
    }
    .progress-text {
      font-size: 12px;
      color: black;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <!-- מצב אתחולי: רק כפתור גדול מופיע -->
  <div id="initial-state">
    <button id="start-button" onclick="startFetching()" aria-label="רענן">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
         <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 1 .908-.418A4 4 0 1 0 8 4V1.5a.5.5 0 0 1 1 0V4a.5.5 0 0 1-.5.5H5a.5.5 0 0 1 0-1h3z"/>
      </svg>
    </button>
  </div>
  <!-- הודעת טעינה -->
  <div id="loading">נטען...</div>
  <!-- תוכן ראשי – יופיע רק אחרי קבלת הנתונים -->
  <div id="content-wrapper">
    <div id="header">
      <div id="logo-container">
        <!-- עדכני את הנתיב לקובץ הלוגו שלך -->
        <img id="logo" src="images/logo.png" alt="Logo">
      </div>
      <div class="header-text">
        <p>נאסף עד כה: <span id="global-progress-text">0</span> מתוך 150000 (<span id="global-progress-percentage">0%</span>)</p>
      </div>
      <button id="fetch-button" onclick="fetchPeople()" aria-label="רענון">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
          <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 1 .908-.418A4 4 0 1 0 8 4V1.5a.5.5 0 0 1 1 0V4a.5.5 0 0 1-.5.5H5a.5.5 0 0 1 0-1h3z"/>
        </svg>
      </button>
    </div>
    <div class="global-progress-bar">
      <div id="global-progress" class="global-progress" style="width: 0%;"></div>
    </div>
    <div id="people-container">
      <div id="us-people" class="people-column"></div>
      <div id="france-people" class="people-column"></div>
      <div id="china-people" class="people-column"></div>
    </div>
  </div>

  <script>
    let globalTotal = 0;
    let allData = '';

    // הפונקציה שמופעלת כאשר לוחצים על הכפתור הראשוני
    function startFetching() {
      // הסתר את מצב האתחול (רק הכפתור)
      document.getElementById("initial-state").style.display = "none";
      // הצג הודעת טעינה
      document.getElementById("loading").style.display = "block";
      // קריאה לטעינת הנתונים
      fetchPeople();
    }

    function fetchPeople() {
      fetch('https://hook.eu2.make.com/utretx4h3a1757e9s6v99ldn72gfu72u', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ request: 'fetch_people' }),
      })
      .then(response => response.json())
      .then(data => {
        // הסתר הודעת טעינה
        document.getElementById("loading").style.display = "none";
        // הצג את התוכן הראשי
        document.getElementById("content-wrapper").style.display = "block";
        displayPeople(data);
        updateGlobalProgress(data);
      })
      .catch(error => {
        console.error("Error fetching data:", error);
        document.getElementById("loading").style.display = "none";
        alert("שגיאה בטעינת המידע");
      });
    }

    function displayPeople(data) {
      const countries = {
        "USA": "us-people",
        "FRANCE": "france-people",
        "CHINA": "china-people"
      };

      const summaryData = data.find(item => item[0] === "0");
      let usaData = '', franceData = '', chinaData = '';

      if (summaryData) {
        const summary = summaryData[1].split(' ');
        summary.forEach(entry => {
          const [key, sum] = entry.split('=');
          if (key === "USA") { usaData = sum; }
          if (key === "FRANCE") { franceData = sum; }
          if (key === "CHINA") { chinaData = sum; }
          if (key === "ALL") { allData = sum; }
        });
      }

      Object.keys(countries).forEach(country => {
        const people = data.filter(person => person[0] === country);
        let content = "";
        let totalAmount = 0;

        if (people.length > 0) {
          content += `<h3>${country === "USA" ? "ארצות הברית" : country === "FRANCE" ? "צרפת" : "סין"}</h3>`;

          if (country === "USA" && usaData) { totalAmount = parseInt(usaData); }
          if (country === "FRANCE" && franceData) { totalAmount = parseInt(franceData); }
          if (country === "CHINA" && chinaData) { totalAmount = parseInt(chinaData); }

          content += `<h4>סכום כולל: ${formatNumber(totalAmount)} ₪</h4>`;
          content += generatePeopleHTML(people.filter(person => person[1] !== "0"), totalAmount);
        }

        document.getElementById(countries[country]).innerHTML = content;
      });

      document.getElementById("people-container").style.display = "flex";
    }

    function generatePeopleHTML(people, target) {
      return people.map(person => `
        <div class="person">
          <div class="person-name">
            <strong>${person[2]}</strong>
          </div>
          <div class="person-info">
            <span class="amount"><strong>סכום:</strong> ${formatNumber(person[3])} ₪</span>
            <span class="target"><strong>יעד:</strong> ${formatNumber(person[4])} ₪</span>
          </div>
          ${generateProgressBar(person[3], person[4])}
        </div>
      `).join('');
    }

    function generateProgressBar(amount, target) {
      if (!target || target === 0) {
        return `<div class="progress-bar"><div class="progress" style="width: 0%"></div></div><div class="progress-text">לא הוגדר יעד</div>`;
      }
      const progressWidth = (amount / target) * 100;
      return `
        <div class="progress-bar">
          <div class="progress" style="width: ${Math.min(progressWidth, 100)}%;"></div>
        </div>
        <div class="progress-text">${formatNumber(amount)} ₪ מתוך ${formatNumber(target)} ₪ (${Math.min(progressWidth, 100).toFixed(2)}% מהיעד הושג)</div>
      `;
    }

    function formatNumber(number) {
      return number.toLocaleString('en');
    }

    function updateGlobalProgress(data) {
      // השתמש בערך ALL שהתקבל מהשרת
      globalTotal = allData ? parseInt(allData) : 0;
      const globalTarget = 150000;
      const progressWidth = (globalTotal / globalTarget) * 100;

      const globalProgressElement = document.getElementById("global-progress");
      const globalProgressTextElement = document.getElementById("global-progress-text");
      const globalProgressPercentageElement = document.getElementById("global-progress-percentage");

      if (globalProgressElement && globalProgressTextElement && globalProgressPercentageElement) {
        globalProgressElement.style.width = `${Math.min(progressWidth, 100)}%`;
        globalProgressTextElement.innerText = `${formatNumber(globalTotal)} ₪`;
        globalProgressPercentageElement.innerText = `${Math.min(progressWidth, 100).toFixed(2)}%`;
      } else {
        console.error("One or more elements are missing in the DOM.");
      }
    }
  </script>
</body>
</html>
